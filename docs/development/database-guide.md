# Database Guide

> ## Document Metadata
> 
> ### ‚úÖ Required
> **Title:** Database Guide - PostgreSQL with SimpleBlog  
> **Description:** Complete guide for working with PostgreSQL database in SimpleBlog including local development, migrations, and troubleshooting  
> **Audience:** developer  
> **Topic:** development  
> **Last Update:** 2026-01-17
>
> ### üìå Recommended
> **Parent Document:** [README.md](./README.md)  
> **Difficulty:** intermediate  
> **Estimated Time:** 20 min  
> **Version:** 1.0.0  
> **Status:** approved
>
> ### üè∑Ô∏è Optional
> **Prerequisites:** Basic SQL knowledge, .NET Aspire installed, Docker Desktop running  
> **Related Docs:** [getting-started.md](./getting-started.md), [project-structure.md](./project-structure.md)  
> **Tags:** `database`, `postgresql`, `ef-core`, `migrations`, `aspire`

---

## üìã Overview

SimpleBlog uses **PostgreSQL** as its database for both local development and production deployment. This guide covers setup, migrations, troubleshooting, and best practices for working with the database.

---

## üéØ Current Setup

### Database Technology Stack

- **Database:** PostgreSQL (latest)
- **ORM:** Entity Framework Core 9.0.10
- **Provider:** Npgsql 9.0.4
- **Orchestration:** .NET Aspire 13.1.0
- **Container:** Docker (managed by Aspire)

### Why PostgreSQL?

SimpleBlog migrated from SQL Server to PostgreSQL for:

- ‚úÖ **Better Performance** - Optimized for concurrent connections
- ‚úÖ **Open Source** - No licensing costs
- ‚úÖ **Cloud-Native** - First-class support on Render, AWS, Azure, GCP
- ‚úÖ **Aspire Integration** - Simplified local development
- ‚úÖ **Production Parity** - Same database locally and in production

---

## üöÄ Local Development

### Automatic Setup with Aspire

When you run `dotnet run --project SimpleBlog.AppHost`, .NET Aspire automatically:

1. **Pulls PostgreSQL Docker image** (if not already present)
2. **Starts PostgreSQL container** with persistent storage
3. **Creates database** named `blogdb`
4. **Applies migrations** automatically
5. **Seeds initial data** (posts, users, products)

### Connection Details

- **Host:** localhost (via Aspire service discovery)
- **Database:** blogdb
- **Port:** Dynamic (managed by Aspire)
- **Credentials:** Auto-generated by Aspire
- **Connection String:** Available in Aspire Dashboard ‚Üí Resources ‚Üí postgres

**To View Connection String:**
1. Start the application
2. Open Aspire Dashboard (URL shown in console)
3. Navigate to **Resources** ‚Üí **postgres**
4. Copy connection string from resource details

---

## üóÑÔ∏è Database Schema

### DbContext Architecture

The application uses **Entity Framework Core** with three separate DbContext classes following the Multi-Context Pattern:

#### 1. ApplicationDbContext
**Purpose:** User authentication and identity management

**Tables:**
- `AspNetUsers` - User accounts
- `AspNetRoles` - User roles
- `AspNetUserRoles` - User-role mappings

**Location:** `SimpleBlog.ApiService/Data/ApplicationDbContext.cs`

#### 2. BlogDbContext
**Purpose:** Blog functionality

**Tables:**
- `Posts` - Blog posts (title, content, image, publishedAt)
- `Comments` - User comments on posts
- `AboutMe` - Static about page content

**Location:** `SimpleBlog.Blog.Services/BlogDbContext.cs`

#### 3. ShopDbContext
**Purpose:** E-commerce functionality

**Tables:**
- `Products` - Shop products (name, price, stock)
- `Orders` - Customer orders (status, total, orderDate)
- `OrderItems` - Line items in orders

**Location:** `SimpleBlog.Shop.Services/ShopDbContext.cs`

**Benefits of Multi-Context:**
- ‚úÖ Clear separation of concerns (Bounded Contexts from DDD)
- ‚úÖ Independent migrations per domain
- ‚úÖ Easier testing (mock individual contexts)
- ‚úÖ Future potential to split into separate databases

All contexts share the same PostgreSQL database connection.

---

## üîÑ Migrations

### Creating Migrations

```bash
# Set environment for PostgreSQL
$env:Database__Provider = "postgresql"

# Create new migration for Blog context
dotnet ef migrations add MigrationName `
    --project SimpleBlog.Blog.Services `
    --context BlogDbContext

# Create new migration for Shop context
dotnet ef migrations add MigrationName `
    --project SimpleBlog.Shop.Services `
    --context ShopDbContext

# Create new migration for Application context
dotnet ef migrations add MigrationName `
    --project SimpleBlog.ApiService `
    --context ApplicationDbContext
```

### Applying Migrations

Migrations are **automatically applied** when the application starts. However, you can also apply them manually:

```bash
# Apply Blog migrations
dotnet ef database update `
    --project SimpleBlog.Blog.Services `
    --context BlogDbContext

# Apply Shop migrations
dotnet ef database update `
    --project SimpleBlog.Shop.Services `
    --context ShopDbContext

# Apply Application migrations
dotnet ef database update `
    --project SimpleBlog.ApiService `
    --context ApplicationDbContext
```

### Removing Migrations

```bash
# Remove last migration (before applying to database)
dotnet ef migrations remove `
    --project SimpleBlog.Blog.Services `
    --context BlogDbContext
```

> ‚ö†Ô∏è **Warning:** Only remove migrations that haven't been applied to any database yet!

### Migration Files Location

- **Blog:** `SimpleBlog.Blog.Services/Data/Migrations/`
- **Shop:** `SimpleBlog.Shop.Services/Data/Migrations/`
- **Application:** `SimpleBlog.ApiService/Data/Migrations/`

---

## üíæ Data Persistence

### Docker Volumes

Data persists across application restarts via Docker volumes managed by Aspire.

```bash
# View PostgreSQL volumes
docker volume ls | Select-String "postgres"

# Inspect volume details
docker volume inspect <volume-name>

# Check volume mount point
docker volume inspect <volume-name> | ConvertFrom-Json | Select-Object -ExpandProperty Mountpoint
```

### Reset Database (Fresh Start)

```bash
# Step 1: Stop the application
# Press Ctrl+C in the terminal running Aspire

# Step 2: Find volume name in Aspire Dashboard or Docker
docker volume ls

# Step 3: Remove the volume
docker volume rm simpleblog-postgres-data

# Step 4: Restart application
dotnet run --project SimpleBlog.AppHost

# Database will be recreated with all migrations and seed data
```

---

## üîç Viewing Database Data

You can connect to the PostgreSQL database using various tools:

### Recommended Tools

#### pgAdmin
- **Type:** Full-featured PostgreSQL GUI
- **Platform:** Windows, Mac, Linux
- **Download:** [pgAdmin.org](https://www.pgadmin.org/)

#### DBeaver
- **Type:** Universal database tool
- **Platform:** Windows, Mac, Linux
- **Download:** [DBeaver.io](https://dbeaver.io/)

#### Azure Data Studio
- **Type:** Microsoft's cross-platform tool
- **Platform:** Windows, Mac, Linux
- **Download:** [Azure Data Studio](https://docs.microsoft.com/sql/azure-data-studio/)

#### VS Code Extension
- **Type:** PostgreSQL extension for VS Code
- **Extension:** PostgreSQL by Chris Kolkman
- **Install:** VS Code Extensions ‚Üí Search "PostgreSQL"

### Connecting to Database

1. Get connection string from Aspire Dashboard (Resources ‚Üí postgres)
2. Extract connection details:
   - Host: usually `localhost`
   - Port: check Aspire Dashboard (dynamic)
   - Database: `blogdb`
   - Username: check connection string
   - Password: check connection string

---

## üêõ Troubleshooting

### Problem: Container Won't Start

**Symptoms:**
- Application fails to start
- "Could not connect to database" errors
- Aspire Dashboard shows postgres as unhealthy

**Solution:**
```bash
# Check Docker is running
docker ps

# Check container logs
docker logs <container-id>

# Restart via Aspire Dashboard
# Or restart entire application
```

**Verification:**
```bash
# Confirm container is running
docker ps | Select-String "postgres"
```

---

### Problem: Connection Errors

**Symptoms:**
- Application starts but can't query database
- "Connection refused" errors
- Timeout exceptions

**Causes and Solutions:**

1. **PostgreSQL container not running**
   ```bash
   # Check in Aspire Dashboard ‚Üí Resources ‚Üí postgres
   # Status should be "Running"
   ```

2. **Incorrect connection string**
   ```bash
   # Verify connection string in environment variables
   # Check Aspire Dashboard for correct connection details
   ```

3. **Migrations not applied**
   ```bash
   # Manually apply migrations
   dotnet ef database update --project SimpleBlog.ApiService
   ```

4. **Firewall blocking connection**
   ```bash
   # Check Windows Firewall
   # Allow Docker Desktop through firewall
   ```

**Verification:**
```bash
# Test connection using psql (if installed)
psql -h localhost -p <port> -U <username> -d blogdb
```

---

### Problem: Migration Conflicts

**Symptoms:**
- "Pending model changes" warning
- Migration fails to apply
- Database schema doesn't match code

**Solution:**
```bash
# Create new migration to capture changes
dotnet ef migrations add FixSchemaConflict `
    --project SimpleBlog.Blog.Services `
    --context BlogDbContext

# Apply migration
dotnet ef database update `
    --project SimpleBlog.Blog.Services `
    --context BlogDbContext
```

**Prevention:**
- Always create migrations before modifying database manually
- Use consistent development workflow across team
- Apply migrations immediately after pulling changes

---

### Problem: Performance Issues

**Symptoms:**
- Slow query execution
- Application timeouts
- High CPU usage

**Solutions:**

1. **Check indexes**
   ```sql
   -- Connect to database and run
   SELECT * FROM pg_stat_user_indexes WHERE schemaname = 'public';
   ```

2. **Analyze slow queries**
   ```sql
   -- Enable query logging
   ALTER DATABASE blogdb SET log_statement = 'all';
   ```

3. **Reset connection pool**
   ```bash
   # Restart application
   # Aspire will recreate connection pool
   ```

---

## ‚öôÔ∏è Configuration

### Connection String Format

```
Host=localhost;Database=blogdb;Username=user;Password=pass;Port=5432
```

### Environment Variables

```bash
# Development
ConnectionStrings__blogdb=<connection-string>
Database__Provider=postgresql

# Production (Render)
DATABASE_URL=<postgres-connection-string>
```

### AppSettings Configuration

```json
{
  "ConnectionStrings": {
    "blogdb": "Host=localhost;Database=blogdb;..."
  },
  "Database": {
    "Provider": "postgresql",
    "SeedData": true
  }
}
```

---

## üöÄ Production Deployment

For production deployment on Render with Managed PostgreSQL:

- ‚úÖ Automated backups
- ‚úÖ High availability options
- ‚úÖ Automatic minor version updates
- ‚úÖ Connection pooling
- ‚úÖ Daily backups (7-day retention on free tier)

See [../deployment/render-guide.md](../deployment/render-guide.md) for detailed deployment instructions.

---

## üìù Quick Reference

### Essential Commands

```bash
# Start application with database
dotnet run --project SimpleBlog.AppHost

# View Aspire Dashboard
# Open URL shown in console (usually http://localhost:15xxx)

# Create migration
dotnet ef migrations add <Name> --project <Project> --context <Context>

# Apply migrations
dotnet ef database update --project <Project> --context <Context>

# Remove last migration
dotnet ef migrations remove --project <Project> --context <Context>

# Reset database
docker volume rm simpleblog-postgres-data
```

### Contexts Quick Reference

| Context | Project | Purpose |
|---------|---------|---------|
| ApplicationDbContext | SimpleBlog.ApiService | Users, Authentication |
| BlogDbContext | SimpleBlog.Blog.Services | Posts, Comments |
| ShopDbContext | SimpleBlog.Shop.Services | Products, Orders |

---

## üîó External Resources

- [PostgreSQL Documentation](https://www.postgresql.org/docs/)
- [Npgsql Documentation](https://www.npgsql.org/doc/)
- [EF Core with PostgreSQL](https://learn.microsoft.com/ef/core/providers/npgsql/)
- [Aspire PostgreSQL Component](https://learn.microsoft.com/dotnet/aspire/database/postgresql-component)
- [EF Core Migrations](https://learn.microsoft.com/ef/core/managing-schemas/migrations/)

---

## üìö Related Documents

- [Getting Started](./getting-started.md) - Initial setup guide
- [Project Structure](./project-structure.md) - Code organization
- [Render Deployment](../deployment/render-guide.md) - Production deployment

---

## üìù Changelog

| Date | Version | Changes |
|------|---------|---------|
| 2026-01-17 | 1.0.0 | Converted from legacy DATABASES.md, added proper metadata |
