# SimpleBlog Databases

## Current Setup

SimpleBlog uses **PostgreSQL** as its database for both local development and production deployment.

## Local Development

When you run `dotnet run --project SimpleBlog.AppHost`, .NET Aspire automatically:

1. **Pulls PostgreSQL Docker image** (if not already present)
2. **Starts PostgreSQL container** with persistent storage
3. **Creates database** named `blogdb`
4. **Applies migrations** automatically
5. **Seeds initial data** (posts, users, products)

### Connection Details

- **Host:** localhost (via Aspire service discovery)
- **Database:** blogdb
- **Port:** Dynamic (managed by Aspire)
- **Credentials:** Auto-generated by Aspire
- **Connection String:** Available in Aspire Dashboard → Resources → postgres

### Viewing Data

You can connect to the database using:

- **pgAdmin** - Full-featured PostgreSQL GUI
- **DBeaver** - Universal database tool
- **Azure Data Studio** - Microsoft's cross-platform tool
- **VS Code Extension** - PostgreSQL extension

Connection info is available in Aspire Dashboard after starting the app.

## Production (Render)

Production deployment uses **Render Managed PostgreSQL**:

- Automated backups
- High availability options
- Automatic minor version updates
- Connection pooling available
- Daily backups (7-day retention on free tier)

See [RENDER_DEPLOYMENT.md](RENDER_DEPLOYMENT.md) for deployment instructions.

## Migrations

### Creating Migrations

```bash
# Set environment for PostgreSQL
$env:Database__Provider = "postgresql"

# Create new migration
dotnet ef migrations add MigrationName --project SimpleBlog.ApiService --context ApplicationDbContext

# Apply migrations
dotnet ef database update --project SimpleBlog.ApiService
```

### Migration Files

Located in [SimpleBlog.ApiService/Data/Migrations/](../SimpleBlog.ApiService/Data/Migrations/)

## Database Schema

The application uses **Entity Framework Core** with three DbContext classes:

1. **ApplicationDbContext** - Main context (Users, authentication)
2. **BlogDbContext** - Blog functionality (Posts, Comments)
3. **ShopDbContext** - E-commerce (Products, Orders)

All contexts share the same PostgreSQL database connection.

## Persistence

Data persists across application restarts via Docker volumes:

```bash
# View volumes
docker volume ls | Select-String "postgres"

# Inspect volume
docker volume inspect <volume-name>

# Remove all data (fresh start)
docker volume rm <volume-name>
```

## Troubleshooting

### Container Won't Start

```bash
# Check logs
docker logs <container-id>

# Restart container via Aspire Dashboard
# Or restart entire application
```

### Connection Errors

1. Verify PostgreSQL container is running (Aspire Dashboard)
2. Check connection string in environment variables
3. Ensure migrations are applied
4. Review logs in Aspire Dashboard

### Reset Database

```bash
# Stop application
# Remove volume (see Aspire Dashboard for volume name)
docker volume rm simpleblog-postgres-data

# Restart application - database will be recreated
dotnet run --project SimpleBlog.AppHost
```

## Version Information

- **PostgreSQL:** Latest (pulled by Aspire)
- **Npgsql Provider:** 9.0.4
- **Entity Framework Core:** 9.0.10
- **Aspire PostgreSQL Hosting:** 13.1.0

## Resources

- [PostgreSQL Documentation](https://www.postgresql.org/docs/)
- [Npgsql Documentation](https://www.npgsql.org/doc/)
- [EF Core with PostgreSQL](https://learn.microsoft.com/ef/core/providers/npgsql/)
- [Aspire PostgreSQL Component](https://learn.microsoft.com/dotnet/aspire/database/postgresql-component)

## Quick Commands

```bash
# Start application (with PostgreSQL)
dotnet run --project SimpleBlog.AppHost

# View Aspire Dashboard
# Open URL shown in console (usually http://localhost:15xxx)

# Create migration
dotnet ef migrations add <Name> --project SimpleBlog.ApiService

# Apply migrations
dotnet ef database update --project SimpleBlog.ApiService

# Remove last migration
dotnet ef migrations remove --project SimpleBlog.ApiService
```

## Migration from SQL Server

SQL Server is no longer supported. The project has been fully migrated to PostgreSQL for:

- **Better performance** - Optimized for concurrent connections
- **Open source** - No licensing costs
- **Cloud-native** - First-class support on Render, AWS, Azure, GCP
- **Aspire integration** - Simplified local development
- **Production parity** - Same database locally and in production

For deployment instructions, see [RENDER_DEPLOYMENT.md](RENDER_DEPLOYMENT.md).
